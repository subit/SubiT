# Code to retrieve user agents for Top 3 browsers.
from urllib2 import Request, urlopen
import re
import os

py_file_path = os.path.join("..", "src", "api", "useragents.py")
py_file_template = \
"""
#===============================================================================
# This file was auto-generated by create_useragents.py. The purpose of this 
# file is to supply a random user agent for SubiT. 
# The list is taken from: www.useragentstring.com. The User-Agents are the 3 
# most popular user-agents out there - IE, FireFox, Chrome.
#===============================================================================

import random

AGENTS = [
    # ======================================================================== #
    # Internet Explorer                                                        #
    # ======================================================================== #
{0}
    # ======================================================================== #
    # Chrome                                                                   #
    # ======================================================================== #
{1}
    # ======================================================================== #
    # Firefox                                                                  #
    # ======================================================================== #
{2}
]

def get_agent():
    \"\"\"
    Retreives a random user agents. The User-Agnets are one from either Chrome,
    I.E. or Firefox.
    \"\"\"
    return random.choice(AGENTS)
"""

def get_useragents(url):
    request = Request(url)
    content = urlopen(request).read().decode('utf-8')
    return re.findall('(?<=\<li\>\<a href=)(?:.*?\>)(.*?)(?=\</a\>\</li\>)', content)


USER_AGENTS_URLS = {
    "Chrome"    :  r'http://www.useragentstring.com/pages/Chrome/',
    "Firefox"   : r'http://www.useragentstring.com/pages/Firefox/',
    "IE"        : r'http://www.useragentstring.com/pages/Internet%20Explorer/'
}

if __name__ == "__main__":
    browsers_user_agents = {
        "Chrome"    : get_useragents(USER_AGENTS_URLS["Chrome"]),
        "Firefox"   : get_useragents(USER_AGENTS_URLS["Firefox"]),
        "IE"        : get_useragents(USER_AGENTS_URLS["IE"])
    }

    for browser, agents in browsers_user_agents.iteritems():
        print browser, ": "
        for agent in agents:
            print "\t", agent

    def format_agent(agent):
        return "\tr\"%s\",\n" % agent.strip()

    ie_agents = \
        "".join(map(lambda u: format_agent(u), browsers_user_agents["IE"]))
    chrome_agents = \
        "".join(map(lambda u: format_agent(u), browsers_user_agents["Chrome"]))
    firefox_agents = \
        "".join(map(lambda u: format_agent(u), browsers_user_agents["Firefox"]))
    # We remove new-line from the last item in the list so it will format in 
    # the correct way. 
    ie_agents = ie_agents.strip("\n")
    chrome_agents = chrome_agents.strip("\n")
    # Because this is the last in the list, we need to remove the lass comma.
    firefox_agents = firefox_agents.strip(",\n")

    output_file_content = py_file_template.format(
        ie_agents, chrome_agents, firefox_agents)

    print "Writing output python file."
    open(py_file_path, "w").write(output_file_content)
    print "Python file written."

    raw_input('Press any key to continue...')